<html>

<head>
  <meta charset="utf-8" name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>typing test</title>
  <style>
    html {
      font-family: monospace;
    }

    #app {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      font-size: 3em;
    }

    span {
      width: .6em;
    }

    p {
      margin: 0px;
      text-align: center;
      font-weight: bolder;
      white-space: nowrap;
    }

    p.err {
      margin-bottom: .8em;
      font-size: .8em;
      font-weight: lighter;
    }

    p.correct {
      background: lightgreen;
    }

    p.incorrect {
      background: lightpink;
    }

    #score {
      z-index: 8;
      position: fixed;
      bottom: 0px;
      left: 0px;
      width: 100%;
      opacity: 50%;
      font-size: 5vw;
    }

    input {
      z-index: 10;
      position: fixed;
      top: 0px;
      left: 0px;
      width: 100%;
      height: 100%;
      opacity: 0%;
    }
  </style>
</head>

<body>
  <div id="app"></div>
  <input AUTOFOCUS id="log"></input>
  <div id="score"></div>
  <script type="module">
    import init from "./pkg/typing.js";
    import * as typing from "./pkg/typing.js";
    // const defaultCopy = `this is a simple paragraph that is meant to be nice and easy to type which is why there will be mommas no periods or any capital letters so i guess this means that it cannot really be considered a paragraph but just a series of run on sentences this should help you get faster at typing as im trying not to use too many difficult words in it although testa one two thireewijef owejf oweijf owiej foweij foiwj ewoifj euwej foiwej fiow ejfoijw eiofj fr`
    const defaultCopy = `this is a simple paragraph that is meant to be nice and easy to type which is why there will be mommas no periods or any capital letters so i guess this means that it cannot really be considered a paragraph but just a series of run on sentences .`
    console.log(defaultCopy.length)
    const defaultDuration = 30;

    const urlSearchParams = new URLSearchParams(window.location.search);
    const params = Object.fromEntries(urlSearchParams.entries());
    let composition = "";
    let debug = ""
    let enableDebug = params.enableDebug || false;
    let copy = params.copy || defaultCopy;
    let duration = params.duration || defaultDuration;
    window.onerror = function (msg, url, line, col, error) {
      debug += `ERR${msg}-${error}!`
    }



    function step(alignment, e) {
      debug += "A";
      if (e.data && (e.inputType === "insertText" || e.inputType === "insertFromPaste")) {
        alignment.type_into_b(e.data);
      } else if (e.inputType === "deleteContentBackward") {
        alignment.backspace_into_b(1);
        log.value += ", ";
      } else if (e.inputType === "deleteWordBackward") {
        alignment.backword_into_b(1);
      } else if (e.inputType === "insertCompositionText") {
        alignment.backspace_into_b(composition.length);
        alignment.type_into_b(e.data);
        debug += `BS-${composition.length}`
        composition = e.data;
      }

      debug += "B";
      let best = alignment.best_scored_alignment();
      debug += "pairs" + best.alignment();
      debug += "built" + best.score() + "!"

      const pairs = best.alignment().match(/../g) || [];
      let built = pairs.reduce((acc, [a, b]) => {
        if (a !== "_") {
          acc.built.push(acc.dangling + b);
          acc.dangling = "";
        } else {
          acc.dangling += b;
        }
        return acc;
      }, { dangling: "", built: [] }).built;
      return { built, score: best.score() };
    };
    init()
      .then(() => {
        console.log("initialized.", typing);


        let paused = true;
        let completed = false;
        let startedAt = 0;
        let score = 0;

        const alignment = typing.AlignmentTable.new(copy);
        const scoreBox = document.getElementById("score");
        const log = document.getElementById("log");

        log.addEventListener("compositionend", (e) => {
          composition = "";
          log.value += " ";
        });

        let c = 0;
        document.getElementById("log").addEventListener("beforeinput", (e) => {
          if (completed) return;
          debug = `i-${c++}-${e.inputType}${e.data} from comp ${composition}>`
          let aligned = step(alignment, e);
          score = aligned.score;
          let built = aligned.built;

          if (paused && built.length > 0) {
            paused = false;
            startedAt = new Date().getTime();
            console.log("STARTD");
          }

          domTyped.forEach((d, i) => {
            let target = "&nbsp;";
            if (built[i] && built[i] !== " ") { target = built[i]; }
            d.innerHTML = target;
            d.setAttribute("class", `${built[i] === copy[i] ? "correct" : built[i] ? "incorrect" : "blank"} err`);
          });
        });

        function displayScore() {
          window.requestAnimationFrame(displayScore);
          if (!enableDebug && (completed || paused)) { return; }
          let rate = 1000 * score / (new Date().getTime() - startedAt);
          let elapsed = .001 * (new Date().getTime() - startedAt);
          let formattedRate = String(rate.toFixed(2)).padStart(5, ' ').replaceAll(' ', '&nbsp;');
          let formattedRemaining = String((duration - elapsed).toFixed(2)).padStart(6, ' ').replaceAll(' ', '&nbsp;');
          scoreBox.innerHTML = (enableDebug ? debug : "") + `${formattedRate} ${formattedRemaining}s`;
          if (!enableDebug && elapsed > duration) {
            completed = true;
            log.parentNode.removeChild(log);
            scoreBox.innerHTML = `${formattedRate} ðŸ‘`;
          }
        }
        displayScore();

        let built = [];
        let domTyped = [];

        const b = document.getElementById("app").innerHTML = `${copy.split("").map((c, i) => `
          <span>
            <p>${c != " " ? c : "&nbsp;"}</p>
            <p id="domTyped${i}" class="err">${built[i] || "&nbsp;"}</p>
          </span>`).join("")}`;

        for (let i = 0; i < copy.length; i++) {
          domTyped.push(document.getElementById(`domTyped${i}`));
        }

      });
  </script>
</body>

</html>